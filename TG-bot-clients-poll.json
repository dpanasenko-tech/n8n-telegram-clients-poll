{
  "name": "TG-bot-clients-poll",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "*",
          "message"
        ],
        "additionalFields": {
          "chatIds": ""
        }
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -1200,
        976
      ],
      "id": "877c6c45-119e-4bbb-9837-886115dcc5cf",
      "name": "Telegram Trigger",
      "webhookId": "668100d6-0e18-4445-9ef8-c4516eeb3f58",
      "executeOnce": false,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "notes": "(опционально) Chat ID(s) whitelist: укажите ID админского чата/группы."
    },
    {
      "parameters": {
        "content": "## Отработка событий в ТГ боте",
        "height": 480,
        "width": 768
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1248,
        736
      ],
      "id": "c178125b-8497-4294-862f-803fecc5372e",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "Пришлите XLSX-файл из CRM «Отмечалка» с данными об активных абонементах. Файл должен быть в формате .xlsx. \nДалее ожидайте обработки файла 1-2 минуты и я пришлю вам сообщение о результате.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        112,
        112
      ],
      "id": "2c3a84da-4e3e-49be-96d3-a8d097d4eec2",
      "name": "загрузите xlsx с данными клиентов",
      "webhookId": "6c53b4af-d57a-4490-9288-3aa5435ef4f2",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot{{ $('конфиг').item.json.accessToken }}/{{$json[\"result\"][\"file_path\"]}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        320,
        688
      ],
      "id": "304964cb-ea44-4357-be33-f0feb6f59bc9",
      "name": "Скачать файл"
    },
    {
      "parameters": {
        "options": {
          "headerRow": true,
          "includeEmptyCells": true,
          "range": "3",
          "readAsString": false
        }
      },
      "name": "Spreadsheet File",
      "type": "n8n-nodes-base.spreadsheetFile",
      "typeVersion": 1,
      "position": [
        544,
        688
      ],
      "id": "5312bb1d-95c8-4e3f-849f-912f00eab2b6",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "452e879c-58a1-4b8e-be25-b0f69fc7793f",
              "name": "message.chat.username",
              "value": "PASTE_TG_ADMIN_USERNAME",
              "type": "string"
            },
            {
              "id": "fa4817ab-1aed-48ff-80a8-adc58c756f3c",
              "name": "admin_chat_ID",
              "value": "PASTE_TG_ADMIN_CHATID",
              "type": "string"
            },
            {
              "id": "41ab1aa9-41f7-4468-98c5-6c7572308d76",
              "name": "accessToken",
              "value": "PASTE_BOT_TOKEN",
              "type": "string"
            },
            {
              "id": "001bc2ea-3ea2-4225-80c0-6f08199e56f2",
              "name": "gs_doc_id",
              "value": "PASTE_GOOGLE_TABLE_ID",
              "type": "string"
            },
            {
              "id": "03ce9ce6-d922-4a81-b598-252837764c61",
              "name": "button_text_upload",
              "value": "Подгрузить данные из Отмечалки",
              "type": "string"
            },
            {
              "id": "dea2b09c-a5c8-4bcd-9c4f-f25a355af177",
              "name": "button_text_poll_init",
              "value": "Найти клиентов на слот",
              "type": "string"
            },
            {
              "id": "6d97fdce-1d4b-4c28-8cf1-43284aa086a1",
              "name": "button_text_poll_launch",
              "value": "Начать опрос клиентов",
              "type": "string"
            },
            {
              "id": "4bb9338c-026e-4e03-8fea-39481063255e",
              "name": "button_text_poll_edit",
              "value": "Изменить параметры поиска",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -976,
        976
      ],
      "id": "b8d27b3c-ed39-405f-af36-51069899182b",
      "name": "конфиг"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e906d204-d815-4cd6-bfff-2be91e6dfb92",
                    "leftValue": "={{$json[\"message\"]?.[\"text\"]?.trim()}}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/start"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json[\"message\"]?.[\"text\"]?.trim()}}",
                    "rightValue": "={{ $json.button_text_upload }}",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "3cccfc5c-73eb-4c8a-9cc0-6094622a04d3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Upload CRM xlsx "
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5189e337-479e-4079-a83f-d5d3a96632a9",
                    "leftValue": "={{$json[\"message\"]?.[\"document\"]?.[\"file_id\"]}}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "file received"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5a7b95a0-17fb-4b6b-87be-9cbaa5ba96b9",
                    "leftValue": "={{$json[\"message\"]?.[\"text\"]?.trim()}}",
                    "rightValue": "={{ $json.button_text_poll_init }}",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Init poll"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6bdc4904-780b-42d1-ad17-8a26de8aa3f2",
                    "leftValue": "={{$json[\"message\"]?.[\"text\"]?.trim()}}",
                    "rightValue": "Изменить параметры",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Edit poll"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9caad6f8-073c-4739-b1cc-b518b7e1314a",
                    "leftValue": "={{$json[\"message\"]?.[\"text\"]?.trim()}}",
                    "rightValue": "={{ $json.button_text_poll_launch }}",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Start poll"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "56ab76b8-e57f-4fb1-8b09-4d1c7ab7e3d5",
                    "leftValue": "={{$json[\"message\"]?.[\"text\"]?.trim()}}",
                    "rightValue": "Клиент записан в расписание",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Клиент записан"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "allMatchingOutputs": false
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -576,
        832
      ],
      "id": "d7d5b352-a693-4cda-a548-19952d4ecdd9",
      "name": "Switch",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "425d2e88-3efb-4526-8c66-ad9a4a0ad9ab",
              "leftValue": "={{ $json[\"Дата обновления данных подписок\"].split(\" \")[0] }}",
              "rightValue": "={{ $now.format('dd.MM.yyyy') }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        544,
        1200
      ],
      "id": "3d2a2d76-f26a-4738-9426-0f698f864056",
      "name": "Данные обновлялись сегодня?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "=Привет! Я - бот, который помогает найти клиентов на освободившиеся слоты к специалистом. ID вашего чата: {{ $('Telegram Trigger').item.json.message.chat.id }}.\nВыберите действие кнопками внизу",
        "replyMarkup": "replyKeyboard",
        "replyKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "={{ $json.button_text_upload }}",
                    "additionalFields": {}
                  },
                  {
                    "text": "={{ $json.button_text_poll_init }}",
                    "additionalFields": {}
                  }
                ]
              }
            }
          ]
        },
        "replyKeyboardOptions": {
          "resize_keyboard": true,
          "one_time_keyboard": false
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -128,
        112
      ],
      "id": "8bf1e598-611e-4b37-a243-8ecc90eaa084",
      "name": "Приветствие и меню с кнопками",
      "webhookId": "6c53b4af-d57a-4490-9288-3aa5435ef4f2",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "content": "## Подгружаем данные из excel Отмечалки в Google Sheeet на лист \"CRM data\" и на лист опросов \"polls\"",
        "height": 672,
        "width": 3904
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -208,
        384
      ],
      "id": "e9f1637a-da0e-4ab4-9b56-9671e521ad9f",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "71fa89fc-d428-4e0f-bbf6-8ee1cbd80d88",
              "leftValue": "={{Object.keys($items()[0].json).join(\",\")}}",
              "rightValue": "№,ФИО посетителя,Телефон,Название абонемента,Кол-во ост. занятий,Дата оплаты,Дата начала,Дата окончания,Стоимость со скидкой,Не отработанных денег,Долг по абонементу,Другая доп. инфо. по посетителю,Филиал,Направление - группа,Преподаватель,Телеграм",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        768,
        688
      ],
      "id": "8cd9bc6b-597b-4318-84e1-e8581a947ca7",
      "name": "структура таблицы верная?",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "«Файл не соответствует шаблону ❌ Проверьте, что выгрузка содержит все нужные колонки из “Отмечалки” и загрузите файл еще раз. ",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        992,
        752
      ],
      "id": "bc4f5a75-eba1-43d7-8a02-4dbaece4ccb1",
      "name": "ошибка структуры",
      "webhookId": "ff47b56d-cd84-40aa-8b9a-b29e0a4fb6ed",
      "executeOnce": true,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('конфиг').first().json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "CRM data",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": 2,
            "Дата обновления данных подписок": "={{ $now.format('dd.MM.yyyy HH:mm:ss') }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "Дата обновления данных подписок",
              "displayName": "Дата обновления данных подписок",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2560,
        400
      ],
      "id": "d5b30fa7-41d2-4f01-bb1f-183ffa3c5e9f",
      "name": "штамп даты обновления в CRM data -А1",
      "executeOnce": true,
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "text": "=✅ Данные подписок в \"CRM data\" обновлены. Теперь можно идти дальше. Нажмете кнопку \"Найти клиентов на слот\"",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2784,
        400
      ],
      "id": "85e9659e-3a95-42e1-a7a0-e589c0d77f0f",
      "name": "данные обновлены",
      "webhookId": "ff47b56d-cd84-40aa-8b9a-b29e0a4fb6ed",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "CRM data",
          "mode": "name"
        },
        "clear": "specificRange",
        "range": "A4:P"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        992,
        512
      ],
      "id": "77e62231-844e-444b-b5de-6e15f5ae7e25",
      "name": "Очищаем CRM data",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "CRM data",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "№": "={{ $json['№'] }}",
            "ФИО посетителя": "={{ $json['ФИО посетителя'] }}",
            "Телефон": "={{ \"'\" + $json['Телефон'] }}",
            "Название абонемента": "={{ $json['Название абонемента'] }}",
            "Кол-во ост. занятий": "={{ $json['Кол-во ост. занятий'] }}",
            "Дата оплаты": "={{ $json['Дата оплаты'] }}",
            "Дата начала": "={{ $json['Дата начала'] }}",
            "Дата окончания": "={{ $json['Дата окончания'] }}",
            "Стоимость со скидкой": "={{ $json['Стоимость со скидкой'] }}",
            "Не отработанных денег": "={{ $json['Не отработанных денег'] }}",
            "Долг по абонементу": "={{ $json['Долг по абонементу'] }}",
            "Другая доп. инфо. по посетителю": "={{ $json['Другая доп. инфо. по посетителю'] }}",
            "Филиал": "={{ $json['Филиал'] }}",
            "Направление - группа": "={{ $json['Направление - группа'] }}",
            "Преподаватель": "={{ $json['Преподаватель'] }}",
            "Телеграм": "={{ $json['Телеграм'] }}"
          },
          "matchingColumns": [
            "№"
          ],
          "schema": [
            {
              "id": "№",
              "displayName": "№",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ФИО посетителя",
              "displayName": "ФИО посетителя",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телефон",
              "displayName": "Телефон",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Название абонемента",
              "displayName": "Название абонемента",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Кол-во ост. занятий",
              "displayName": "Кол-во ост. занятий",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата оплаты",
              "displayName": "Дата оплаты",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата начала",
              "displayName": "Дата начала",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата окончания",
              "displayName": "Дата окончания",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Стоимость со скидкой",
              "displayName": "Стоимость со скидкой",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Не отработанных денег",
              "displayName": "Не отработанных денег",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Долг по абонементу",
              "displayName": "Долг по абонементу",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Другая доп. инфо. по посетителю",
              "displayName": "Другая доп. инфо. по посетителю",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Филиал",
              "displayName": "Филиал",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Направление - группа",
              "displayName": "Направление - группа",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Преподаватель",
              "displayName": "Преподаватель",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телеграм",
              "displayName": "Телеграм",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата обновления данных подписок",
              "displayName": "Дата обновления данных подписок",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 3
            }
          },
          "useAppend": true
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1216,
        512
      ],
      "id": "406f75fe-3e01-45e3-b34d-88aa97ae8159",
      "name": "Перезаписываем CRM data",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "={{ $('конфиг').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "polls",
          "mode": "name"
        },
        "options": {
          "returnFirstMatch": false
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1440,
        512
      ],
      "id": "6c37fb0b-d495-4751-a550-cf556ffe489a",
      "name": "Читаем poll",
      "executeOnce": true,
      "retryOnFail": false,
      "waitBetweenTries": 5000,
      "maxTries": 2,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "combineBySql",
        "query": "SELECT\n  input1.[№],\n  input1.[ФИО посетителя],\n  input1.[Телефон],\n  input1.[Название абонемента],\n  input1.[Кол-во ост. занятий],\n  input1.[Дата оплаты],\n  input1.[Дата начала],\n  input1.[Дата окончания],\n  input1.[Стоимость со скидкой],\n  input1.[Не отработанных денег],\n  input1.[Долг по абонементу],\n  input1.[Другая доп. инфо. по посетителю],\n  input1.[Филиал],\n  input1.[Направление - группа],\n  input1.[Преподаватель],\n  input1.[Телеграм],\n  input2.[Дата и время опроса],\n  input2.[Статус опроса],\n  input2.[Клиент добавился в бот?],\n  input2.[Chat ID]\nFROM input1\nLEFT JOIN input2\nON TRIM(LOWER(input1.[ФИО посетителя])) = TRIM(LOWER(input2.[ФИО посетителя]))",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1888,
        592
      ],
      "id": "12d20791-7d0e-4699-8135-cf64257a6d4b",
      "name": "Соединяем клиентов с опросами"
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "polls",
          "mode": "name"
        },
        "clear": "specificRange",
        "range": "A2:U"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2112,
        592
      ],
      "id": "485f3b38-3534-4575-95ed-170224d72f32",
      "name": "Очищаем polls",
      "retryOnFail": false,
      "waitBetweenTries": 5000,
      "alwaysOutputData": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "={{ $('конфиг').first().json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "polls",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {
            "№": "={{ $('Соединяем клиентов с опросами').first().json['№'] }}",
            "ФИО посетителя": "={{ $('Соединяем клиентов с опросами').first().json['ФИО посетителя'] }}",
            "Телефон": "='{{ $('Соединяем клиентов с опросами').first().json['Телефон'] }}",
            "Название абонемента": "={{ $('Соединяем клиентов с опросами').first().json['Название абонемента'] }}",
            "Кол-во ост. занятий": "={{ $('Соединяем клиентов с опросами').first().json['Кол-во ост. занятий'] }}",
            "Дата оплаты": "={{ $('Соединяем клиентов с опросами').first().json['Дата оплаты'] }}",
            "Дата начала": "={{ $('Соединяем клиентов с опросами').first().json['Дата начала'] }}",
            "Дата окончания": "={{ $('Соединяем клиентов с опросами').first().json['Дата окончания'] }}",
            "Стоимость со скидкой": "={{ $('Соединяем клиентов с опросами').first().json['Стоимость со скидкой'] }}",
            "Не отработанных денег": "={{ $('Соединяем клиентов с опросами').first().json['Не отработанных денег'] }}",
            "Долг по абонементу": "={{ $('Соединяем клиентов с опросами').first().json['Долг по абонементу'] }}",
            "Другая доп. инфо. по посетителю": "={{ $('Соединяем клиентов с опросами').first().json['Другая доп. инфо. по посетителю'] }}",
            "Филиал": "={{ $('Соединяем клиентов с опросами').first().json['Филиал'] }}",
            "Направление - группа": "={{ $('Соединяем клиентов с опросами').first().json['Направление - группа'] }}",
            "Преподаватель": "={{ $('Соединяем клиентов с опросами').first().json['Преподаватель'] }}",
            "Телеграм": "={{ $('Соединяем клиентов с опросами').first().json['Телеграм'] }}",
            "Дата и время опроса": "={{ $('Соединяем клиентов с опросами').first().json['Дата и время опроса']}}",
            "Статус опроса": "={{ $('Соединяем клиентов с опросами').first().json['Статус опроса'] }}",
            "Клиент добавился в бот?": "={{ $('Соединяем клиентов с опросами').first().json['Клиент добавился в бот?'] }}",
            "Chat ID": "={{ $('Соединяем клиентов с опросами').first().json['Chat ID'] }}",
            "resumeUrl": "="
          },
          "matchingColumns": [
            "ФИО посетителя"
          ],
          "schema": [
            {
              "id": "№",
              "displayName": "№",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ФИО посетителя",
              "displayName": "ФИО посетителя",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телефон",
              "displayName": "Телефон",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Название абонемента",
              "displayName": "Название абонемента",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Кол-во ост. занятий",
              "displayName": "Кол-во ост. занятий",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата оплаты",
              "displayName": "Дата оплаты",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата начала",
              "displayName": "Дата начала",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата окончания",
              "displayName": "Дата окончания",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Стоимость со скидкой",
              "displayName": "Стоимость со скидкой",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Не отработанных денег",
              "displayName": "Не отработанных денег",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Долг по абонементу",
              "displayName": "Долг по абонементу",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Другая доп. инфо. по посетителю",
              "displayName": "Другая доп. инфо. по посетителю",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Филиал",
              "displayName": "Филиал",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Направление - группа",
              "displayName": "Направление - группа",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Преподаватель",
              "displayName": "Преподаватель",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телеграм",
              "displayName": "Телеграм",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата и время опроса",
              "displayName": "Дата и время опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Статус опроса",
              "displayName": "Статус опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Клиент добавился в бот?",
              "displayName": "Клиент добавился в бот?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Chat ID",
              "displayName": "Chat ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "resumeUrl",
              "displayName": "resumeUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "useAppend": false
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2336,
        592
      ],
      "id": "88a553cb-b922-4e92-964b-5190ab97e691",
      "name": "пишем новые данные в polls",
      "retryOnFail": false,
      "waitBetweenTries": 5000,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "CRM data",
          "mode": "name"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRangeA1",
              "range": "A1:A2"
            }
          },
          "outputFormatting": {
            "values": {
              "general": "FORMATTED_VALUE",
              "date": "FORMATTED_STRING"
            }
          },
          "returnFirstMatch": false
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        368,
        1200
      ],
      "id": "379fb28c-39ac-4860-9e33-83cb8cd210a8",
      "name": "Читаем дату обновления",
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "content": "## Инициализация опроса клиентов",
        "height": 384,
        "width": 1008
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        320,
        1104
      ],
      "id": "0d272a45-2035-443e-8da0-6b703fa3d436",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Инструкции администратору",
        "height": 336,
        "width": 544
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -208,
        0
      ],
      "id": "adba17ab-b0b9-43db-bef1-17406bd93c1d",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Switch').item.json.message.document.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        96,
        688
      ],
      "id": "e7a71dc4-97e7-4791-b906-64536adf146c",
      "name": "Забираем файл из чата",
      "webhookId": "bced0218-e54a-4af2-9b60-27ad3f5045c2",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "Данные пользователей проверены✅ ",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        752,
        1136
      ],
      "id": "cd96d194-18e5-4354-8478-b9b365dc7d78",
      "name": "данные пользователей ОК",
      "webhookId": "30eb2fbe-51a0-48c8-b260-90519ddd87eb",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "Данные о клиентах устарели. Пришлите XLSX-файл из CRM «Отмечалка» с данными об активных абонементах. Файл должен быть в формате .xlsx.",
        "replyMarkup": "replyKeyboard",
        "replyKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Подгрузить данные клиентов",
                    "additionalFields": {}
                  },
                  {
                    "text": "Найти клиентов на этот слот",
                    "additionalFields": {}
                  }
                ]
              }
            }
          ]
        },
        "replyKeyboardOptions": {
          "resize_keyboard": true,
          "one_time_keyboard": false
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        752,
        1296
      ],
      "id": "39950fbe-8233-4261-8971-c4dee233ef41",
      "name": "данные устарели - обновите",
      "webhookId": "6c53b4af-d57a-4490-9288-3aa5435ef4f2",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "Введите текстом параметры текущей записи, на которую вы хотите найти клиента, включая \n1) специализацию, \n2) фамилию и имя специалиста,\n3) дату и время записи.\n\nНапример вот так:\n\nПсихолог Иванова Анна 10 октября 18:00",
        "replyMarkup": "replyKeyboard",
        "replyKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "={{ $('конфиг').item.json.button_text_poll_init }}",
                    "additionalFields": {}
                  }
                ]
              }
            }
          ]
        },
        "replyKeyboardOptions": {},
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        944,
        1136
      ],
      "id": "8365c538-885b-4604-93d1-293967f103f2",
      "name": "введите параметры поиска",
      "webhookId": "30eb2fbe-51a0-48c8-b260-90519ddd87eb",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "state",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
            "params_text": "={{ $('Telegram Trigger').item.json.message.text }}",
            "user": "={{ $('Telegram Trigger').item.json.message.chat.username }}",
            "updated_at": "={{ $now.format('dd.MM.yyyy HH:mm:ss') }}",
            "row_number": 2
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user",
              "displayName": "user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "params_text",
              "displayName": "params_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1488,
        1152
      ],
      "id": "813ed9d3-007c-485b-ba44-f9ba626d1a86",
      "name": "записываем сообщение пользователя в state",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "=Параметры сохранил! Перед стартом опроса проверьте их и подтвердите кнопкой \"Начать опрос клиентов\":\n\n➡️➡️<b>{{ $json.params_text }}</b>⬅️⬅️",
        "replyMarkup": "replyKeyboard",
        "replyKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "=▶️{{ $('конфиг').item.json.button_text_poll_launch }}",
                    "additionalFields": {}
                  },
                  {
                    "text": "=✍🏻{{ $('конфиг').item.json.button_text_poll_edit }}",
                    "additionalFields": {}
                  }
                ]
              }
            }
          ]
        },
        "replyKeyboardOptions": {},
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1712,
        1152
      ],
      "id": "308d6748-bfaf-4979-a429-19b6e4896c8d",
      "name": "данные опроса сохранены",
      "webhookId": "30eb2fbe-51a0-48c8-b260-90519ddd87eb",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "content": "## Сохранение данных опроса",
        "height": 384,
        "width": 592
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1376,
        1120
      ],
      "id": "277157ba-992c-44de-8f92-8d4eaceda4af",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Старт опроса",
        "height": 400,
        "width": 1216
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2016,
        1120
      ],
      "id": "6a97badb-5a0b-4221-a7ab-ea2887a15f14",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## Проверка данных опроса",
        "height": 384,
        "width": 480
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -208,
        1104
      ],
      "id": "9677eeef-cf11-4c4f-9c72-d7d5fc2b3c91",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "state",
          "mode": "name"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "chat_id",
              "lookupValue": "={{ $('конфиг').item.json.message.chat.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -128,
        1264
      ],
      "id": "f4b3a166-b71e-4397-bdd7-7f8260e5deac",
      "name": "Читаем введенные пользователем данные",
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "={{ $('конфиг').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "state",
          "mode": "name"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2528,
        1232
      ],
      "id": "004ab404-137b-4fbf-a9ab-b243a6451608",
      "name": "читаем параметры опроса",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "Файл увидел, начинаю обработку! Подождите пару минут...⏱️",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -128,
        688
      ],
      "id": "9b052c68-a563-4bba-89b7-55da7b246499",
      "name": "проверяем файл",
      "webhookId": "6293caa8-f2fd-499d-89e6-e679ce65423e",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "=Введите в сообщении новые параметры и нажмите \"Отправить\" 📲 |  \"Enter\" 👨‍💻",
        "replyMarkup": "replyKeyboard",
        "replyKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "=▶️{{ $('конфиг').item.json.button_text_poll_launch }}",
                    "additionalFields": {}
                  },
                  {
                    "text": "=✍🏻{{ $('конфиг').item.json.button_text_poll_edit }}",
                    "additionalFields": {}
                  }
                ]
              }
            }
          ]
        },
        "replyKeyboardOptions": {},
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        96,
        1264
      ],
      "id": "39d7ca6b-9017-43c3-890c-2d0723a6a2d6",
      "name": "проверьте параметры поиска",
      "webhookId": "30eb2fbe-51a0-48c8-b260-90519ddd87eb",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "Здравствуйте, уважаемый клиент! Я - бот \"Данилка Центра\", который иногда будет предлагать вам освободившиеся слоты для записи у специалистов.  Пока ничего делать не нужно, просто не блокируйте и не выключайте у меня уведомления.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -144,
        1680
      ],
      "id": "7cbb0575-9225-423c-b510-8d8638763ce1",
      "name": "Установка контакта с клиентом",
      "webhookId": "9b3672f6-18fc-4dbe-8d3b-4ad654d774bf",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $('Находим запись по username').item.json.row_number }}",
            "Клиент добавился в бот?": "=да,  {{ $now.format('dd.MM.yyyy') }}",
            "Chat ID": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "№",
              "displayName": "№",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ФИО посетителя",
              "displayName": "ФИО посетителя",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телефон",
              "displayName": "Телефон",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Название абонемента",
              "displayName": "Название абонемента",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Кол-во ост. занятий",
              "displayName": "Кол-во ост. занятий",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата оплаты",
              "displayName": "Дата оплаты",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата начала",
              "displayName": "Дата начала",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата окончания",
              "displayName": "Дата окончания",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Стоимость со скидкой",
              "displayName": "Стоимость со скидкой",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Не отработанных денег",
              "displayName": "Не отработанных денег",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Долг по абонементу",
              "displayName": "Долг по абонементу",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Другая доп. инфо. по посетителю",
              "displayName": "Другая доп. инфо. по посетителю",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Филиал",
              "displayName": "Филиал",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Направление - группа",
              "displayName": "Направление - группа",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Преподаватель",
              "displayName": "Преподаватель",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телеграм",
              "displayName": "Телеграм",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Дата и время опроса",
              "displayName": "Дата и время опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Статус опроса",
              "displayName": "Статус опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Клиент добавился в бот?",
              "displayName": "Клиент добавился в бот?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Chat ID",
              "displayName": "Chat ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "resumeUrl",
              "displayName": "resumeUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        912,
        1664
      ],
      "id": "fb57572a-5177-4e44-82d0-f15ed910d248",
      "name": "статус добавления бота в ТГ в polls",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bf652eb2-562c-4e3b-935c-02f403609900",
              "name": "row_number",
              "value": "={{ $json[\"callback_query\"][\"data\"].split(\":\")[1] }}",
              "type": "string"
            },
            {
              "id": "51d212c9-c8ee-4fa3-bd79-0cba87ec0e4e",
              "name": "action",
              "value": "={{ $json.callback_query.data.split(':')[0] === 'poll_yes' ? 'yes' : 'no' }}",
              "type": "string"
            },
            {
              "id": "f56ef3fe-2882-42c2-a741-19d41bad581f",
              "name": "chat_id",
              "value": "={{ $json.callback_query.message.chat.id }}",
              "type": "string"
            },
            {
              "id": "9136d133-19c2-46fd-977d-5df93d6fc0fc",
              "name": "username",
              "value": "={{ $json.callback_query.message.chat.username }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        128,
        2208
      ],
      "id": "e3f77f14-8f2f-44bf-a56f-0e4f7dbb3296",
      "name": "Разобрать callback"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "81413d21-5980-4f92-b147-42cdc4b00808",
              "leftValue": "={{ $json['Статус опроса'] }}",
              "rightValue": "ожидание",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        800,
        2208
      ],
      "id": "f9c53449-3796-45c7-840c-004a95efd41a",
      "name": "статус опроса еще \"ожидание\"?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6c8008e6-af26-4e8c-a651-0033f05174b3",
              "leftValue": "={{ $('Разобрать callback').item.json.action }}",
              "rightValue": "yes",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1248,
        2112
      ],
      "id": "d2e1e150-af1f-4607-9516-be8263ff0f06",
      "name": "Согласился?"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $('статус опроса еще \"ожидание\"?').item.json.row_number }}",
            "Статус опроса": "отказался",
            "resumeUrl": "\"\""
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "№",
              "displayName": "№",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ФИО посетителя",
              "displayName": "ФИО посетителя",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телефон",
              "displayName": "Телефон",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Название абонемента",
              "displayName": "Название абонемента",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Кол-во ост. занятий",
              "displayName": "Кол-во ост. занятий",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата оплаты",
              "displayName": "Дата оплаты",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата начала",
              "displayName": "Дата начала",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата окончания",
              "displayName": "Дата окончания",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Стоимость со скидкой",
              "displayName": "Стоимость со скидкой",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Не отработанных денег",
              "displayName": "Не отработанных денег",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Долг по абонементу",
              "displayName": "Долг по абонементу",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Другая доп. инфо. по посетителю",
              "displayName": "Другая доп. инфо. по посетителю",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Филиал",
              "displayName": "Филиал",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Направление - группа",
              "displayName": "Направление - группа",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Преподаватель",
              "displayName": "Преподаватель",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телеграм",
              "displayName": "Телеграм",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата и время опроса",
              "displayName": "Дата и время опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Статус опроса",
              "displayName": "Статус опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Клиент добавился в бот?",
              "displayName": "Клиент добавился в бот?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Chat ID",
              "displayName": "Chat ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "resumeUrl",
              "displayName": "resumeUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1472,
        2208
      ],
      "id": "0ae8d11a-55e4-4d95-9e3a-1aea51f21510",
      "name": "пишем статус отказался",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Switch1').item.json.callback_query.id }}",
        "additionalFields": {
          "text": "❌ Опрос уже закрыт"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1024,
        2304
      ],
      "id": "d555ae4e-3612-4d41-ba82-dda212d5a156",
      "name": "Клиенту: опрос уже закрыт",
      "webhookId": "9b3672f6-18fc-4dbe-8d3b-4ad654d774bf",
      "alwaysOutputData": false,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        352,
        2208
      ],
      "id": "5d6db145-0dc7-4b6f-815e-479d71d18cf8",
      "name": "читаем polls",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('строка ответившего клиента').item.json.resumeUrl }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "row_number",
              "value": "={{ $('строка ответившего клиента').item.json.row_number }}"
            },
            {
              "name": "action",
              "value": "={{ $('Разобрать callback').item.json.action }}"
            },
            {
              "name": "chat_id",
              "value": "={{ $('Разобрать callback').item.json.chat_id }}"
            },
            {
              "name": "username",
              "value": "={{ $('Разобрать callback').item.json.username }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1456,
        1984
      ],
      "id": "f53ce1ef-b76c-4bf2-91db-e3c1e807b4c2",
      "name": "Будим WAIT - конец опроса - успех"
    },
    {
      "parameters": {
        "content": "## Коннект клиента с ботом\nподумать: перенести в WF1, после тегеграм триггера, чтобы обрабатывать бота все события одним триггером",
        "height": 320,
        "width": 1392
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -208,
        1552
      ],
      "id": "e2ad6906-6fc9-4cd9-8d8c-537326a27f7a",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "start",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "2b6c8d11-5736-43f9-b257-ce9b9ad5e67c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "start"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f43bbb1b-55bb-4cec-b45c-fc61b1639ce3",
                    "leftValue": "={{ $('Telegram Trigger').item.json.callback_query.data }}",
                    "rightValue": "poll",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "poll feedback"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -528,
        1904
      ],
      "id": "daee5b1b-f14d-4722-b152-b1427fb4aabf",
      "name": "Switch1",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Развилка: это первый контакт с ботом или ответ на опрос?",
        "height": 320,
        "width": 448
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -720,
        1760
      ],
      "id": "d5347747-38c7-481b-b737-c25b1246b89a",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## Клиент ответил на опрос\n\n",
        "height": 608,
        "width": 2544
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -192,
        1920
      ],
      "id": "cd430769-86e4-4521-8aa1-b05e9c95c87d",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.chat.username }}",
                    "rightValue": "={{ $json.message.chat.username }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f4b8fbf9-ff54-4c3d-905d-593aee9f8b47"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "админ"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1ee4be98-5982-44a6-a217-a61727ed6b4e",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.chat.username }}",
                    "rightValue": "={{ $json.message.chat.username }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "клиент"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -768,
        976
      ],
      "id": "0d07a616-3571-4135-9600-78a037a3e12f",
      "name": "пишет админ или клиент?"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "6pxwMO4iMcy1V2UQ",
          "mode": "list",
          "cachedResultUrl": "/workflow/6pxwMO4iMcy1V2UQ",
          "cachedResultName": "WF2-poll-procedure copy"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "admin_chat_id": "={{ $('конфиг').item.json.message.chat.id }}",
            "gs_doc_id": "={{ $('конфиг').item.json.gs_doc_id }}",
            "params_text": "={{ $json.params_text }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "admin_chat_id",
              "displayName": "admin_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "params_text",
              "displayName": "params_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "gs_doc_id",
              "displayName": "gs_doc_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": true,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2752,
        1232
      ],
      "id": "942929dc-b17a-4f66-938b-456e25248015",
      "name": "Call 'WF2-poll-procedure copy'",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "6d7d7f16-e161-43ac-a9d9-bd78784c4153",
              "leftValue": "={{ $json.row_number }}",
              "rightValue": "={{ $('Разобрать callback').item.json.row_number }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        576,
        2208
      ],
      "id": "f16b08b2-2b8f-4b78-a152-6f6ced3b251b",
      "name": "строка ответившего клиента"
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "={{ $('конфиг').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "clear": "specificRange",
        "range": "Q2:R"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2080,
        1232
      ],
      "id": "284b7b50-389a-494e-b78b-355999f63976",
      "name": "Clear sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "={{ $('конфиг').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "clear": "specificRange",
        "range": "U2:U"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2304,
        1232
      ],
      "id": "0dbc7c66-fcc5-49c2-9470-9d5740081a2a",
      "name": "Clear sheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.admin_chat_id }}",
        "text": "Начинаем опрос...",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2976,
        1232
      ],
      "id": "f4e19055-1ecb-4c87-b6fd-bb7aae88dec4",
      "name": "администратору: начинаем опрос",
      "webhookId": "30eb2fbe-51a0-48c8-b260-90519ddd87eb",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "content": "## Чистим статусы опроса",
        "height": 192,
        "width": 400,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2048,
        1200
      ],
      "id": "13fb01b8-4655-454a-b9f6-b4430017dbbf",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "chatId": "={{ $('строка ответившего клиента').item.json['Chat ID'] }}",
        "text": "✅Ответ принят",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1024,
        2112
      ],
      "id": "291c015a-5e5e-4cb3-a1aa-9f651ba1a863",
      "name": "Клиенту: ответ принят1",
      "webhookId": "9b3672f6-18fc-4dbe-8d3b-4ad654d774bf",
      "alwaysOutputData": false,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Статус опроса",
              "lookupValue": "ожидание"
            }
          ]
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1696,
        2304
      ],
      "id": "39ba2926-612a-4a61-8f65-cafafa103c4e",
      "name": "оставшиеся в ожидании ответа",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "81413d21-5980-4f92-b147-42cdc4b00808",
              "leftValue": "={{ $json }}",
              "rightValue": "ожидание",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1920,
        2304
      ],
      "id": "598db51c-a38d-4bc7-a766-0bc1d9644658",
      "name": "есть не ответившие?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('строка ответившего клиента').item.json.resumeUrl }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "action",
              "value": "=all_no"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2144,
        2304
      ],
      "id": "56a1c93f-5124-4f65-920c-b25468906070",
      "name": "Будим WAIT - все отказались"
    },
    {
      "parameters": {
        "content": "## Запускаем новую группу опроса, если все отказались",
        "height": 288,
        "width": 688,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1632,
        2176
      ],
      "id": "26a758e2-45fe-430f-9679-0138a8780a4f",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "content": "## START HERE\n",
        "height": 208,
        "width": 256,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1056,
        928
      ],
      "id": "320352df-d161-43d3-a227-cf56ff8b4f52",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "chatId": "={{ $('конфиг').item.json.admin_chat_ID }}",
        "text": "=Клиент <b>{{ $('статус опроса еще \"ожидание\"?').item.json['ФИО посетителя'] }} отказался </b>записаться",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1696,
        2016
      ],
      "id": "2c7b615b-b174-4510-a8fb-81737e012a1f",
      "name": "Ответ админу об отказе",
      "webhookId": "3047f901-935c-4bbb-9e6c-a6730d47e731",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "={{ $('конфиг').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        16,
        1664
      ],
      "id": "b9b5f75c-9f6b-418d-960f-7be007599da5",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dd7efbeb-279c-4d2a-9fb6-c6cb260dc447",
              "leftValue": "={{$items().length}}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        464,
        1664
      ],
      "id": "c99e765b-6f43-49f5-a0d7-f50d0baa8ef5",
      "name": "есть дубли username?"
    },
    {
      "parameters": {
        "chatId": "={{ $('конфиг').item.json.admin_chat_ID }}",
        "text": "=Я нашел у себя в списке клиентов строки с одинаковыми Telegram username. Это не ограничивает запуск опроса, но может привести к выбору не тех клиентов, которые нам нужны. Проверьте, пожалуйста, таблицу с клиентами из Отмечалки и устраните дубли. \n\nЗаписи клиентов с дублями:\n{{ $json['ФИО посетителя'] }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        688,
        1600
      ],
      "id": "30770d2a-750e-4f80-81f4-fd0f768909a3",
      "name": "Админу: есть дубли TG username",
      "webhookId": "3047f901-935c-4bbb-9e6c-a6730d47e731",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cc0d48d0-39fa-4c4c-aa1c-47b501be6736",
              "leftValue": "={{ $json['Телеграм'].trim().replace(/\\\\s+/g, '').replace(/^@/, '').toLowerCase() }}",
              "rightValue": "={{ $('Telegram Trigger').item.json.message.from.username.toLowerCase() }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        240,
        1664
      ],
      "id": "cb4db88c-9bc6-4592-a15a-03b683395b0f",
      "name": "Находим запись по username"
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  item.json.attempt = item.json.attempt ? item.json.attempt + 1 : 1;\n  return item;\n});"
      },
      "id": "20fa728e-3142-4ba7-8c76-a31f43f7d3e2",
      "name": "Set Attempt1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2560,
        592
      ]
    },
    {
      "parameters": {
        "amount": 60,
        "unit": "seconds"
      },
      "id": "034c59f5-d0d3-4a56-823f-11bcc0f7c46c",
      "name": "Wait 60 sec1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        3008,
        656
      ],
      "webhookId": "b85fdd80-5c7c-4990-9a5b-61fda5e434ac"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json[\"attempt\"]}}",
              "value2": 4
            }
          ]
        }
      },
      "id": "1b59e274-335e-4f04-932e-155fdfa79717",
      "name": "IF Attempt < 4 (1)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2784,
        592
      ],
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $('конфиг').first().json.admin_chat_ID }}",
        "text": "=❗ Ошибка в воркфлоу: WF1-data-update-&-poll-init |Описание ошибки: \"ошибка записи/очистки данных в гугл таблице\". Попробуйте еще раз через 1 минуту.",
        "additionalFields": {}
      },
      "id": "754faff3-24a0-49f8-8206-8119b1a9bf15",
      "name": "Notify Admin Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        3232,
        848
      ],
      "webhookId": "b4be8626-9a25-4d78-acb2-298d333ca955",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{ $('конфиг').first().json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 1210621797,
          "mode": "list",
          "cachedResultName": "Logs",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=1210621797"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $now.format('dd.MM.yyyy HH:mm') }}",
            "workflowName": "WF1-data-update-&-poll-init",
            "errorMessage": "ошибка записи/очистки данных в гугл таблице - превышено число запросов к Google API",
            "nodeName": "google sheets",
            "userId (optional)": "={{ $('Telegram Trigger').first().json.message.from.username }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "workflowName",
              "displayName": "workflowName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "errorMessage",
              "displayName": "errorMessage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "stackTrace",
              "displayName": "stackTrace",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nodeName",
              "displayName": "nodeName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "userId (optional)",
              "displayName": "userId (optional)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "details",
              "displayName": "details",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3456,
        848
      ],
      "id": "99c3b627-5dd9-4999-b642-43a52a366cca",
      "name": "пишем логи в таблицу",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "amount": 60,
        "unit": "seconds"
      },
      "id": "afb115aa-21a7-41db-a869-de2133ccf267",
      "name": "Wait 60 sec2",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        3008,
        848
      ],
      "webhookId": "b85fdd80-5c7c-4990-9a5b-61fda5e434ac"
    },
    {
      "parameters": {
        "jsCode": "// items = массив объектов input2 (список записей из input 2)\n\nconst seen = new Set();\nconst result = [];\n\nfor (const item of items) {\n  // Получение нормализованного ФИО (убрать пробелы, привести к нижнему регистру)\n  const fio = (item.json[\"ФИО посетителя\"] || \"\")\n    .trim()\n    .toLowerCase();\n\n  if (!seen.has(fio)) {\n    seen.add(fio);\n    result.push(item);\n  }\n}\n\n// Возврат уникального массива (input2 без дублей)\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1664,
        512
      ],
      "id": "67283b87-30ce-4b99-b736-6cd8bbea565a",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "={{ $('webhook').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange"
            }
          },
          "outputFormatting": {
            "values": {
              "general": "UNFORMATTED_VALUE",
              "date": "FORMATTED_STRING"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1152,
        3184
      ],
      "id": "7752085c-33c7-4c42-9023-5b236da76cca",
      "name": "берем кандидатов в polls",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('webhook').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "polls",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $('Loop Over Items').item.json.row_number }}",
            "Статус опроса": "ожидание",
            "Дата и время опроса": "={{ $now.format('dd.MM.yyyy HH:mm') }}",
            "resumeUrl": "={{ $('делаем ResumeUrl').item.json.resumeUrl }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "№",
              "displayName": "№",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ФИО посетителя",
              "displayName": "ФИО посетителя",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телефон",
              "displayName": "Телефон",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Название абонемента",
              "displayName": "Название абонемента",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Кол-во ост. занятий",
              "displayName": "Кол-во ост. занятий",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата оплаты",
              "displayName": "Дата оплаты",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата начала",
              "displayName": "Дата начала",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата окончания",
              "displayName": "Дата окончания",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Стоимость со скидкой",
              "displayName": "Стоимость со скидкой",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Не отработанных денег",
              "displayName": "Не отработанных денег",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Долг по абонементу",
              "displayName": "Долг по абонементу",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Другая доп. инфо. по посетителю",
              "displayName": "Другая доп. инфо. по посетителю",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Филиал",
              "displayName": "Филиал",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Направление - группа",
              "displayName": "Направление - группа",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Преподаватель",
              "displayName": "Преподаватель",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телеграм",
              "displayName": "Телеграм",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата и время опроса",
              "displayName": "Дата и время опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Статус опроса",
              "displayName": "Статус опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Клиент добавился в бот?",
              "displayName": "Клиент добавился в бот?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Chat ID",
              "displayName": "Chat ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "resumeUrl",
              "displayName": "resumeUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        528,
        3184
      ],
      "id": "46134895-d7ce-4ed6-a173-185320ae2e33",
      "name": "штамп ожидание в polls",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "resume": "webhook",
        "httpMethod": "POST",
        "limitWaitTime": true,
        "resumeAmount": 60,
        "resumeUnit": "minutes",
        "options": {
          "rawBody": true,
          "webhookSuffix": ""
        }
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        720,
        3184
      ],
      "id": "6617359f-1019-4367-9256-d0a2ef542fc3",
      "name": "Wait",
      "webhookId": "ced6410c-05d6-4972-89f0-e1c9c9003775"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "8d48bd95-9fb2-48af-a8aa-508f28a39351",
              "leftValue": "={{ $json['Телеграм'] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "519b55c2-0bd3-41fd-ada7-84a32253ce84",
              "leftValue": "={{ $json['Клиент добавился в бот?'] }}",
              "rightValue": "да",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "9fa90a77-46b9-4a99-b56c-41762b25e43f",
              "leftValue": "={{ $json['Название абонемента'] }}",
              "rightValue": "плавающ",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "8834e17e-6e80-4885-a44a-f1cbd2409723",
              "leftValue": "={{ $json['Статус опроса'] }}",
              "rightValue": "не ответил",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "adb16232-9ff2-4e26-b446-d22254240b91",
              "leftValue": "={{ $json['Статус опроса'] }}",
              "rightValue": "ожидание",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "7a0c630b-5d01-4acb-94fc-b22d40a8b8be",
              "leftValue": "={{ $json['Статус опроса'] }}",
              "rightValue": "завершен",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "12faaf96-bc47-4a29-af11-c9f3e0e5b59b",
              "leftValue": "={{ $json['Кол-во ост. занятий'] }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -800,
        3184
      ],
      "id": "a2b8f7c1-af2c-4377-9da7-49aa5f00b814",
      "name": "Отбор клиентов по критериям",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput",
      "notes": "Есть ТГ , плавающий абонемент, не опрашивали еще"
    },
    {
      "parameters": {
        "chatId": "={{ $json['Chat ID'] }}",
        "text": "=Здравствуйте, {{ $json['ФИО посетителя'] }}! Освободился слот:\n<b>{{ $('webhook').first().json.params_text }}</b>\nГотовы занять? \nОкно ожидания ответа — 1 час",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Да, записывайте!",
                    "additionalFields": {
                      "callback_data": "=poll_yes:{{ $('Loop Over Items').item.json.row_number }}"
                    }
                  },
                  {
                    "text": "Нет, точно не приду",
                    "additionalFields": {
                      "callback_data": "=poll_no:{{ $('Loop Over Items').item.json.row_number }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        144,
        3184
      ],
      "id": "48fda6d1-b40c-4be9-ac3a-e0ef2f7c603e",
      "name": "Приглашение клиентов",
      "webhookId": "1ab397cf-eb05-4471-ba28-f716f1544d9f",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('webhook').item.json.admin_chat_id }}",
        "text": "=Опрос закончен успешно!🎉\n\nКлиент <b>{{ $json['ФИО посетителя'] }} согласился записаться к {{ $('webhook').item.json.params_text }}</b>\n\nАбоненмент клиента: {{ $json['Название абонемента'] }}\nКол-во оставшихся занятий: {{ $json['Кол-во ост. занятий'] }}\nДата окончания: {{ $json['Дата окончания'] }}\n\n💡Запишите его в расписание!💡 ",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Записать в расписание",
                    "additionalFields": {
                      "url": "https://docs.google.com/spreadsheets/d/1Oov-Rk3nEdgaffXbdkOSifnCiP4klAjGA4fr_lP2sE8/edit?gid=0#gid=0"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1728,
        2752
      ],
      "id": "520d6a50-3dea-4655-99f2-ea62f99f0ee6",
      "name": "Ответ админу о завершении опроса",
      "webhookId": "3047f901-935c-4bbb-9e6c-a6730d47e731",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('webhook').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "polls",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $('согласившийся клиент').item.json.row_number }}",
            "Статус опроса": "=согласился записаться: {{ $('webhook').item.json.params_text }}",
            "Дата и время опроса": "={{ $now.format('dd.MM.yyyy HH:mm') }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "№",
              "displayName": "№",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ФИО посетителя",
              "displayName": "ФИО посетителя",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телефон",
              "displayName": "Телефон",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Название абонемента",
              "displayName": "Название абонемента",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Кол-во ост. занятий",
              "displayName": "Кол-во ост. занятий",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата оплаты",
              "displayName": "Дата оплаты",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата начала",
              "displayName": "Дата начала",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата окончания",
              "displayName": "Дата окончания",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Стоимость со скидкой",
              "displayName": "Стоимость со скидкой",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Не отработанных денег",
              "displayName": "Не отработанных денег",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Долг по абонементу",
              "displayName": "Долг по абонементу",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Другая доп. инфо. по посетителю",
              "displayName": "Другая доп. инфо. по посетителю",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Филиал",
              "displayName": "Филиал",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Направление - группа",
              "displayName": "Направление - группа",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Преподаватель",
              "displayName": "Преподаватель",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телеграм",
              "displayName": "Телеграм",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата и время опроса",
              "displayName": "Дата и время опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Статус опроса",
              "displayName": "Статус опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Клиент добавился в бот?",
              "displayName": "Клиент добавился в бот?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Chat ID",
              "displayName": "Chat ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2144,
        2944
      ],
      "id": "5742be05-bac8-4e50-9c9c-1d6756cde9e7",
      "name": "штамп согласился в polls",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1328,
        3184
      ],
      "id": "51ff4d13-1d97-420b-81b9-830227d2e519",
      "name": "webhook"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "519b55c2-0bd3-41fd-ada7-84a32253ce84",
              "leftValue": "={{ $json.row_number }}",
              "rightValue": "={{ $('Wait').item.json.body.row_number }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {
          "ignoreCase": false
        }
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        1472,
        2944
      ],
      "id": "8818330e-5272-48d8-a65a-b8690b4c7702",
      "name": "согласившийся клиент",
      "notes": "Есть ТГ , плавающий абонемент, не опрашивали еще"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "519b55c2-0bd3-41fd-ada7-84a32253ce84",
              "leftValue": "={{ $json['Статус опроса'] }}",
              "rightValue": "=ожидание",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {
          "ignoreCase": false
        }
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        2512,
        2944
      ],
      "id": "3aefda00-027d-4eff-a7fb-b54083ab126b",
      "name": "неуспевшие ответить",
      "notes": "Есть ТГ , плавающий абонемент, не опрашивали еще"
    },
    {
      "parameters": {
        "chatId": "={{ $json['Chat ID'] }}",
        "text": "={{ $('неуспевшие ответить').item.json['ФИО посетителя'] }}, запись закрыта🎬 \nКто-то уже записался...",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2736,
        2944
      ],
      "id": "d2efe18a-2f92-4616-b66b-b6d343781c32",
      "name": "Клиентам: опрос завершен",
      "webhookId": "b9b89d86-85c9-43d0-9ea2-d16293ddc5f8",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('webhook').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "polls",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $('неуспевшие ответить').item.json.row_number }}",
            "Статус опроса": "=завершен",
            "Дата и время опроса": "={{ $now.format('dd.MM.yyyy HH:mm') }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "№",
              "displayName": "№",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ФИО посетителя",
              "displayName": "ФИО посетителя",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телефон",
              "displayName": "Телефон",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Название абонемента",
              "displayName": "Название абонемента",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Кол-во ост. занятий",
              "displayName": "Кол-во ост. занятий",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата оплаты",
              "displayName": "Дата оплаты",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата начала",
              "displayName": "Дата начала",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата окончания",
              "displayName": "Дата окончания",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Стоимость со скидкой",
              "displayName": "Стоимость со скидкой",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Не отработанных денег",
              "displayName": "Не отработанных денег",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Долг по абонементу",
              "displayName": "Долг по абонементу",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Другая доп. инфо. по посетителю",
              "displayName": "Другая доп. инфо. по посетителю",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Филиал",
              "displayName": "Филиал",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Направление - группа",
              "displayName": "Направление - группа",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Преподаватель",
              "displayName": "Преподаватель",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телеграм",
              "displayName": "Телеграм",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата и время опроса",
              "displayName": "Дата и время опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Статус опроса",
              "displayName": "Статус опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Клиент добавился в бот?",
              "displayName": "Клиент добавился в бот?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Chat ID",
              "displayName": "Chat ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2960,
        2944
      ],
      "id": "679f78f9-65ae-4e9d-bbe8-44b89b8237d3",
      "name": "штамп завершен в polls",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "yes",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "29bb3b74-b860-4846-b266-eef04bd2970b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "есть согласный"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7c184aea-349d-424f-80c2-614dd168160c",
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "all_no",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "все отказались"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ed0e1634-a674-487b-936d-ab1bd99c410f",
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "empty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "никто не ответил"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        944,
        3152
      ],
      "id": "32d3643d-e8f9-44e0-9137-25ab8b27406d",
      "name": "результат опроса",
      "executeOnce": false
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1200,
        3168
      ],
      "id": "bff0d814-c200-41e4-8e8d-01c88ebd5ef7",
      "name": "читаем polls1",
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "519b55c2-0bd3-41fd-ada7-84a32253ce84",
              "leftValue": "={{ $json['Статус опроса'] }}",
              "rightValue": "=отказался",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {
          "ignoreCase": false
        }
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        1472,
        3168
      ],
      "id": "056eab0e-5376-481c-a12e-b935740f94d1",
      "name": "отказавшиеся",
      "notes": "Есть ТГ , плавающий абонемент, не опрашивали еще"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('webhook').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "polls",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "Статус опроса": "=завершен",
            "Дата и время опроса": "={{ $now.format('dd.MM.yyyy HH:mm') }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "№",
              "displayName": "№",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ФИО посетителя",
              "displayName": "ФИО посетителя",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телефон",
              "displayName": "Телефон",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Название абонемента",
              "displayName": "Название абонемента",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Кол-во ост. занятий",
              "displayName": "Кол-во ост. занятий",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата оплаты",
              "displayName": "Дата оплаты",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата начала",
              "displayName": "Дата начала",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата окончания",
              "displayName": "Дата окончания",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Стоимость со скидкой",
              "displayName": "Стоимость со скидкой",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Не отработанных денег",
              "displayName": "Не отработанных денег",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Долг по абонементу",
              "displayName": "Долг по абонементу",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Другая доп. инфо. по посетителю",
              "displayName": "Другая доп. инфо. по посетителю",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Филиал",
              "displayName": "Филиал",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Направление - группа",
              "displayName": "Направление - группа",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Преподаватель",
              "displayName": "Преподаватель",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телеграм",
              "displayName": "Телеграм",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата и время опроса",
              "displayName": "Дата и время опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Статус опроса",
              "displayName": "Статус опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Клиент добавился в бот?",
              "displayName": "Клиент добавился в бот?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Chat ID",
              "displayName": "Chat ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1712,
        3168
      ],
      "id": "9ac6c054-2283-4958-b002-0ed256c0c0f4",
      "name": "штамп завершен в polls1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "856b3d53-c09a-4f05-b69f-8eb3b32f4d68",
              "name": "resumeUrl",
              "value": "={{ $execution.resumeUrl }}",
              "type": "string"
            },
            {
              "id": "e1b6a4ff-cb83-4a29-b005-12b9bcb77f30",
              "name": "poll_number",
              "value": "={{ $execution.resumeUrl.split(\"waiting/\").pop() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        352,
        3184
      ],
      "id": "ba029760-c5c9-4cbd-8f1d-ef382edae939",
      "name": "делаем ResumeUrl"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2336,
        2944
      ],
      "id": "17f460ca-db4a-4d22-8eac-a0a9eff22432",
      "name": "читаем polls2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('согласившийся клиент').item.json['Chat ID'] }}",
        "text": "=Поздравляем!🎉 Вы записаны к специалисту {{ $('webhook').item.json.params_text }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2336,
        3152
      ],
      "id": "c0211ddd-63e3-475e-866e-20e7d81cac74",
      "name": "Клиенту: вы записаны",
      "webhookId": "7f916e5a-c947-404c-a87e-06863870c210",
      "alwaysOutputData": false,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('webhook').item.json.admin_chat_id }}",
        "text": "После того, как запишите клиента, нажмите кнопку \"Клиент записан в расписание\", чтобы вернуться в предыдущее меню ",
        "replyMarkup": "replyKeyboard",
        "replyKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Клиент записан в расписание",
                    "additionalFields": {}
                  }
                ]
              }
            }
          ]
        },
        "replyKeyboardOptions": {},
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1952,
        2752
      ],
      "id": "af0c64af-dafb-4e76-b58e-f39e1b33905c",
      "name": "Возврат в меню после записи",
      "webhookId": "ac475ddf-bd10-4ac4-965b-5059bd0f111d",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1184,
        3408
      ],
      "id": "bf573394-2468-4bbf-85a2-a477da233203",
      "name": "читаем polls3",
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "519b55c2-0bd3-41fd-ada7-84a32253ce84",
              "leftValue": "={{ $json['Статус опроса'] }}",
              "rightValue": "=ожидание",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {
          "ignoreCase": false
        }
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        1456,
        3408
      ],
      "id": "74b36bfb-fd98-4968-857a-49e777935902",
      "name": "ожидание",
      "notes": "Есть ТГ , плавающий абонемент, не опрашивали еще"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('webhook').item.json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "polls",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "Статус опроса": "=не ответил",
            "Дата и время опроса": "={{ $now.format('dd.MM.yyyy HH:mm') }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "№",
              "displayName": "№",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ФИО посетителя",
              "displayName": "ФИО посетителя",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телефон",
              "displayName": "Телефон",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Название абонемента",
              "displayName": "Название абонемента",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Кол-во ост. занятий",
              "displayName": "Кол-во ост. занятий",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата оплаты",
              "displayName": "Дата оплаты",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата начала",
              "displayName": "Дата начала",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата окончания",
              "displayName": "Дата окончания",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Стоимость со скидкой",
              "displayName": "Стоимость со скидкой",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Не отработанных денег",
              "displayName": "Не отработанных денег",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Долг по абонементу",
              "displayName": "Долг по абонементу",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Другая доп. инфо. по посетителю",
              "displayName": "Другая доп. инфо. по посетителю",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Филиал",
              "displayName": "Филиал",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Направление - группа",
              "displayName": "Направление - группа",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Преподаватель",
              "displayName": "Преподаватель",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Телеграм",
              "displayName": "Телеграм",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Дата и время опроса",
              "displayName": "Дата и время опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Статус опроса",
              "displayName": "Статус опроса",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Клиент добавился в бот?",
              "displayName": "Клиент добавился в бот?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Chat ID",
              "displayName": "Chat ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1728,
        3408
      ],
      "id": "a0c0713b-a12a-4576-bdb4-6783bd0bc21c",
      "name": "штамп \"не ответил\" в polls",
      "alwaysOutputData": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "batchSize": 3,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -400,
        3184
      ],
      "id": "92fcabd5-df98-4f80-b6c2-35ab9a051ce5",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "chatId": "={{ $('ожидание').item.json['Chat ID'] }}",
        "text": "={{ $('ожидание').item.json['ФИО посетителя'] }}, время ответа вышло. Запись закрыта🎬 \n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1968,
        3408
      ],
      "id": "a8aa5972-ea20-472c-b222-435ea1fd4716",
      "name": "Клиентам: опрос завершен1",
      "webhookId": "b9b89d86-85c9-43d0-9ea2-d16293ddc5f8",
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('webhook').first().json.admin_chat_id }}",
        "text": "=Опрос завершен. К сожалению, никто не согласился записаться на этот слот🙈\nНо не отчаивайтесь, в следующий раз вам точно повезет!🤞🙂",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        16,
        2800
      ],
      "id": "cec31c51-60c7-4a7c-bd54-1cc087cce5b9",
      "name": "Ответ админу о неуспешном опросе",
      "webhookId": "e8b152ec-4071-453d-aca7-3d4851a0b946",
      "executeOnce": true,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Вход: items – массив объектов клиентов\n// Параметр из webhook\nconst text = $node[\"webhook\"].json.params_text; // например \"Нейропсихолог Мокина 22 октября 15:00\"\n\n// 1. Находим все слова длиной >= 5 символов\nconst possibleNames = text.split(/\\s+/).filter(word => word.length >= 5);\n\n// 2. Игнорируем профессии, даты и пр. (чёрный список)\nconst blacklist = [\"Нейропсихолог\", \"Логопед\", \"октября\", \"ноября\", \"сентября\", \"декабря\", \"время\", \"центр\", \"пригласить\"];\nconst surnames = possibleNames.filter(word => !blacklist.includes(word));\n\n// 3. Фильтруем клиентов (items) по ТОЧНОМУ совпадению фамилии в поле \"Преподаватель\"\nconst result = items.filter(item => {\n  const prepod = item.json[\"Преподаватель\"] || \"\";\n  \n  // Разбиваем строку \"Преподаватель\" на отдельные слова\n  const prepodWords = prepod.split(/[\\s,\\.]+/).filter(word => word.length > 0);\n  \n  // Проверяем точное совпадение любой фамилии из запроса с любым словом из поля \"Преподаватель\"\n  return surnames.some(surname =>\n    prepodWords.some(prepodWord => \n      prepodWord.toLowerCase() === surname.toLowerCase()\n    )\n  );\n});\n\n// 4. Возвращаем результат\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -960,
        3184
      ],
      "id": "5dc16611-d0fb-4991-8a85-94dbae7a4a40",
      "name": "Проверка подписки",
      "executeOnce": false,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('webhook').first().json.admin_chat_id }}",
        "text": "=📋Отправляем сообщения клиентам:\n<b>{{ $json.allNames }}</b> \n⏰Срок ожидания ответа — до {{ $now.plus({hours: 1}).format('HH:mm') }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        512,
        3008
      ],
      "id": "31060f0d-d62e-4041-b948-dd8d45c0571c",
      "name": "Админу: текущий статус опроса",
      "webhookId": "e8b152ec-4071-453d-aca7-3d4851a0b946",
      "executeOnce": true,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('webhook').first().json.admin_chat_id }}",
        "text": "=Клиенты не ответили. Начинаем выбирать новых для опропроса...",
        "replyMarkup": "inlineKeyboard",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2176,
        3408
      ],
      "id": "4f738fe2-3cbd-45b0-b976-6a2c88911475",
      "name": "Админу: никто не ответил",
      "webhookId": "3047f901-935c-4bbb-9e6c-a6730d47e731",
      "executeOnce": true,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7fbdc330-eea5-4614-81fc-9c35ca989eea",
              "leftValue": "={{ $json }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -608,
        3184
      ],
      "id": "86012ac3-b705-49cd-8f69-a43f210ba8e5",
      "name": "кто-то соответствует фильтрам?"
    },
    {
      "parameters": {
        "chatId": "={{ $('webhook').first().json.admin_chat_id }}",
        "text": "=🚫Опрос начать не получилось, потому что никто из клиентов не соответствует необходимым параметрам опроса. В чем может быть причина:\n- нет клиентов с нужным направляением в абонементе,\n- остаток занятий равен нулю.\n\n💡Попробуйте проверить написание фамилии и специальности в параметрах опроса, которые вы ввели и запустите процесс еще раз! ",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -400,
        3008
      ],
      "id": "96f01663-e130-4e36-b836-0fe19c785a40",
      "name": "Админу: нет соответствующих клиентов",
      "webhookId": "e8b152ec-4071-453d-aca7-3d4851a0b946",
      "executeOnce": true,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Опрос группы из 3 клиентов с ожиданием ответа 1 час",
        "height": 1088,
        "width": 4512,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1312,
        2672
      ],
      "id": "3d62a697-47bf-4b6c-b3e0-e20626dd4151",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
          "mode": "list",
          "cachedResultName": "Детский центр: поиск клиентов на запись",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 94230102,
          "mode": "list",
          "cachedResultName": "polls",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=94230102"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1200,
        2944
      ],
      "id": "0a8f64ed-1ed0-4626-9796-6adc690972b8",
      "name": "читаем polls4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Собираем все фамилии в одну строку через запятую\nconst allNames = items.map(item => item.json[\"ФИО посетителя\"]).join(', ');\nreturn [{ json: { allNames } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32,
        3024
      ],
      "id": "807abba1-625f-4b05-b75a-2e57c4918549",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "chatId": "={{ $('webhook').item.json.admin_chat_id }}",
        "text": "=Группа опрошенных <b>отказалась записываться к {{ $('webhook').item.json.params_text }}</b>",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1936,
        3168
      ],
      "id": "5665671e-7215-4dc5-a35e-87339a59185e",
      "name": "Ответ админу об отказе1",
      "webhookId": "3047f901-935c-4bbb-9e6c-a6730d47e731",
      "executeOnce": true,
      "credentials": {
        "telegramApi": {
          "id": "6It9zILg2Nk79EVp",
          "name": "@danilkaclub_raspisanie_neiro_bot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $json.admin_chat_ID }}",
        "text": "=❗ Ошибка в воркфлоу: {{ $json.workflow.name }} |Описание ошибки: {{ $json.execution.error.message }} Бот попробует ещё раз, если лимит превышен — посмотрите лог. ",
        "additionalFields": {}
      },
      "id": "5b31bc9d-6bd3-43ec-aa16-0c1c1083234c",
      "name": "Notify Admin Telegram1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        -816,
        3920
      ],
      "webhookId": "b4be8626-9a25-4d78-acb2-298d333ca955",
      "credentials": {
        "telegramApi": {
          "id": "AmhxSokVANFFYKg7",
          "name": "dpanasenko_content_test_bot"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fa4817ab-1aed-48ff-80a8-adc58c756f3c",
              "name": "admin_chat_ID",
              "value": "96086270",
              "type": "string"
            },
            {
              "id": "41ab1aa9-41f7-4468-98c5-6c7572308d76",
              "name": "accessToken",
              "value": "7631407032:AAFYs-3VCE-SDlEWK8DVBEyEC2wmw_vi0bo",
              "type": "string"
            },
            {
              "id": "001bc2ea-3ea2-4225-80c0-6f08199e56f2",
              "name": "gs_doc_id",
              "value": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1072,
        4000
      ],
      "id": "c4c8970a-11af-4283-91a9-9700bddc361b",
      "name": "конфиг1"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{ $json.gs_doc_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 1210621797,
          "mode": "list",
          "cachedResultName": "Logs",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc/edit#gid=1210621797"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $now.format('dd.MM.yyyy HH:mm') }}",
            "workflowName": "={{ $('Error Trigger').item.json.workflow.name }}",
            "errorMessage": "={{ $('Error Trigger').item.json.execution.error.message }}",
            "stackTrace": "={{ $('Error Trigger').item.json.execution.error.stack }}",
            "nodeName": "={{ $('Error Trigger').item.json.execution.lastNodeExecuted }}",
            "userId (optional)": "={{ $json.message.chat.username }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "workflowName",
              "displayName": "workflowName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "errorMessage",
              "displayName": "errorMessage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "stackTrace",
              "displayName": "stackTrace",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nodeName",
              "displayName": "nodeName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "userId (optional)",
              "displayName": "userId (optional)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "details",
              "displayName": "details",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -816,
        4096
      ],
      "id": "8cbd5875-acde-4d6d-8146-dab46199a974",
      "name": "пишем логи в таблицу1",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "8j8GlbRpYCXHqjZ3",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "content": "## Logging workflow \n",
        "height": 464,
        "width": 768,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1296,
        3824
      ],
      "id": "52b0c418-dc36-4b4f-a4ce-d7213738468d",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "content": "## Telegram bot logic \n",
        "height": 2624,
        "width": 5104,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1328,
        -48
      ],
      "id": "06442834-4f5e-4e11-8369-645b2d09ce3f",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "## README\n***\n\n### What this project does\n\nThese two workflows are combined into a single system automating CRM operations, user Excel data processing, and comprehensive survey management via Telegram.  \n**Process Flow:**\n- The user uploads a CRM XLSX file via the Telegram bot (WF1).\n- The file is parsed and the data is synced with Google Sheets (CRM, state, and survey tables).\n- An administrator or user launches a survey via the bot—buttons allow starting, editing, and selecting respondents (WF1 triggers WF2).\n- WF2 processes survey logic: creates questions, records answers, tracks user states, updates Google Sheets entries, supports both mass/batch and individual notifications.\n- All logic and user states are stored and synchronized—the organizational and survey functionality is tightly integrated.\n\n***\n\n### WF2 Survey Logic\n\n- **Main “polls” Google Sheet:**  \n  Stores poll assignments, statuses, respondent positions, last action times, ResumeUrl for async processing.\n- **Poll state handling and updating:**  \n  Each poll step (launched, completed, skipped, answered) is stored by rownumber.\n- **User action waiting:**  \n  Wait node holds the workflow for user response via Telegram; ResumeUrl allows returning to the appropriate checkpoint (async survey).\n- **Action types and routing:**  \n  - Handling Yes/No clicks on in-line buttons for each question.\n  - Routing based on response type (Switch, Filter).\n  - Automated repeat requests, skipping, completion—using timers or conditions.\n- **Telegram integration:**  \n  - Messages, questions, results sent to users or groups via the bot.\n  - Batch mailings, one-on-one dialogs, notifications of completion.\n- **JavaScript nodes:**  \n  For advanced answer processing, name filtering, logging edge cases.\n\n***\n\n### Setup instructions\n\n1. **Prepare integrations:**\n   - Telegram bot with sending and webhook rights, chatId for users.\n   - GoogleAuth (OAuth2) for Google Sheets access.\n2. **Configure tables:**\n   - “CRM data” for clients.\n   - “polls” for survey management.\n   - “state” for recording user statuses.\n   - “Logs” for error logs and action history.\n3. **Import both WF1 and WF2 workflows.**\n   - Link WF1 to WF2 via ExecuteWorkflow node—use the correct WF2 id.\n   - Check every table’s id (documentId), sheetName—must match live files.\n   - Enter all required variables, chatId, whitelist, adminchatId.\n4. **Expand Telegram button structure:**  \n   Add required actions (start survey, finish, skip, yes/no), command descriptions, info buttons.\n5. **Test the workflow in a limited mode:**  \n   Use test xlsx files, trial survey groups, and pre-filled CRM data.\n\n***\n\n### Supporting documents/files\n\n- **CRM xlsx template** for syncing via Telegram (structure: Name, contacts, status).\n- **Google Sheets:**\n  - “CRM data”—client table.\n  - “polls”—surveys, rownumber, action, answers, ResumeUrl.\n  - “state”—parameters, chatId, timestamps.\n  - “Logs”—errors and action history.\n- **README (quick guide):**\n  Document describing workflow steps, commands, table structures, survey launch and parameter options.\n- **chatId whitelist list.**\n- **Survey FAQ:**  \n  FAQ file for users explaining the survey logic, commands, question types.\n\n***\n\n### Deployment highlights:\n\n- All survey logic is in WF2: batch, continuous, async respondent management, automatic routing.\n- The WF1 + WF2 bundle lets you scale the system with a single Telegram bot and cloud Google Sheets.\n- Flexible expansion: add new survey types, adapt buttons and actions, connect extra databases.\n\n***\n\n**In summary:**  \nThe project enables full-cycle automation of CRM + survey operations using a Telegram bot and Google Sheets. All stages—from upload, processing, launching, survey completion, to logging and analytics—are implemented in a linked workflow chain.[1]\n\nIf you need sample table structures or a CRM file example—just ask!\n\n[1](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/124341335/a8bcb4d4-f63d-40b1-813f-152ec168f99e/WF2-poll-procedure-copy.json)",
        "height": 1936,
        "width": 896
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2448,
        -48
      ],
      "id": "5a554445-162b-4a7b-9be6-80c8755343c0",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "content": "## START HERE\n",
        "height": 208,
        "width": 256,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1136,
        3936
      ],
      "id": "04b2192c-222a-4bb5-a4ad-582d162a2bfa",
      "name": "Sticky Note19"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        -1248,
        4000
      ],
      "id": "ec3eb3d8-77a3-425b-bfaa-8dd603cb0882",
      "name": "Error Trigger"
    }
  ],
  "pinData": {
    "webhook": [
      {
        "json": {
          "row_number": 2,
          "chat_id": 524276680,
          "user": "pde87",
          "params_text": "Нейропсихолог Мокина 29 октября 15:00",
          "updated_at": "24.10.2025 9:41:05",
          "admin_chat_id": "524276680",
          "gs_doc_id": "1cY4mTrIU4-1wb1e5_PWM9s4UC2jsxXsDis3f61gXzlc"
        }
      }
    ]
  },
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "конфиг",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Скачать файл": {
      "main": [
        [
          {
            "node": "Spreadsheet File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Spreadsheet File": {
      "main": [
        [
          {
            "node": "структура таблицы верная?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "конфиг": {
      "main": [
        [
          {
            "node": "пишет админ или клиент?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Приветствие и меню с кнопками",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "загрузите xlsx с данными клиентов",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "проверяем файл",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Читаем дату обновления",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Читаем введенные пользователем данные",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Clear sheet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Приветствие и меню с кнопками",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "записываем сообщение пользователя в state",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Данные обновлялись сегодня?": {
      "main": [
        [
          {
            "node": "данные пользователей ОК",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "данные устарели - обновите",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "структура таблицы верная?": {
      "main": [
        [
          {
            "node": "Очищаем CRM data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Соединяем клиентов с опросами",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ошибка структуры",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "штамп даты обновления в CRM data -А1": {
      "main": [
        [
          {
            "node": "данные обновлены",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Очищаем CRM data": {
      "main": [
        [
          {
            "node": "Перезаписываем CRM data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Перезаписываем CRM data": {
      "main": [
        [
          {
            "node": "Читаем poll",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Читаем poll": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Соединяем клиентов с опросами": {
      "main": [
        [
          {
            "node": "Очищаем polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Очищаем polls": {
      "main": [
        [
          {
            "node": "пишем новые данные в polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "пишем новые данные в polls": {
      "main": [
        [
          {
            "node": "штамп даты обновления в CRM data -А1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Attempt1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Читаем дату обновления": {
      "main": [
        [
          {
            "node": "Данные обновлялись сегодня?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Забираем файл из чата": {
      "main": [
        [
          {
            "node": "Скачать файл",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "данные пользователей ОК": {
      "main": [
        [
          {
            "node": "введите параметры поиска",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "записываем сообщение пользователя в state": {
      "main": [
        [
          {
            "node": "данные опроса сохранены",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Читаем введенные пользователем данные": {
      "main": [
        [
          {
            "node": "проверьте параметры поиска",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "читаем параметры опроса": {
      "main": [
        [
          {
            "node": "Call 'WF2-poll-procedure copy'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "проверяем файл": {
      "main": [
        [
          {
            "node": "Забираем файл из чата",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Установка контакта с клиентом": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Разобрать callback": {
      "main": [
        [
          {
            "node": "читаем polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "статус опроса еще \"ожидание\"?": {
      "main": [
        [
          {
            "node": "Клиенту: ответ принят1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Клиенту: опрос уже закрыт",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Согласился?": {
      "main": [
        [
          {
            "node": "Будим WAIT - конец опроса - успех",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "пишем статус отказался",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "пишем статус отказался": {
      "main": [
        [
          {
            "node": "оставшиеся в ожидании ответа",
            "type": "main",
            "index": 0
          },
          {
            "node": "Ответ админу об отказе",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "читаем polls": {
      "main": [
        [
          {
            "node": "строка ответившего клиента",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Установка контакта с клиентом",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Разобрать callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "пишет админ или клиент?": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'WF2-poll-procedure copy'": {
      "main": [
        [
          {
            "node": "администратору: начинаем опрос",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "строка ответившего клиента": {
      "main": [
        [
          {
            "node": "статус опроса еще \"ожидание\"?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear sheet": {
      "main": [
        [
          {
            "node": "Clear sheet1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear sheet1": {
      "main": [
        [
          {
            "node": "читаем параметры опроса",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Клиенту: ответ принят1": {
      "main": [
        [
          {
            "node": "Согласился?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "оставшиеся в ожидании ответа": {
      "main": [
        [
          {
            "node": "есть не ответившие?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "есть не ответившие?": {
      "main": [
        [],
        [
          {
            "node": "Будим WAIT - все отказались",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Находим запись по username",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "есть дубли username?": {
      "main": [
        [
          {
            "node": "Админу: есть дубли TG username",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "статус добавления бота в ТГ в polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Админу: есть дубли TG username": {
      "main": [
        [
          {
            "node": "статус добавления бота в ТГ в polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Находим запись по username": {
      "main": [
        [
          {
            "node": "есть дубли username?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Attempt1": {
      "main": [
        [
          {
            "node": "IF Attempt < 4 (1)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 60 sec1": {
      "main": [
        [
          {
            "node": "пишем новые данные в polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Attempt < 4 (1)": {
      "main": [
        [
          {
            "node": "Wait 60 sec1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait 60 sec2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify Admin Telegram": {
      "main": [
        [
          {
            "node": "пишем логи в таблицу",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 60 sec2": {
      "main": [
        [
          {
            "node": "Notify Admin Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Соединяем клиентов с опросами",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "берем кандидатов в polls": {
      "main": [
        [
          {
            "node": "Проверка подписки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "штамп ожидание в polls": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "результат опроса",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Отбор клиентов по критериям": {
      "main": [
        [
          {
            "node": "кто-то соответствует фильтрам?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Приглашение клиентов": {
      "main": [
        [
          {
            "node": "делаем ResumeUrl",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ответ админу о завершении опроса": {
      "main": [
        [
          {
            "node": "Возврат в меню после записи",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "штамп согласился в polls": {
      "main": [
        [
          {
            "node": "читаем polls2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Клиенту: вы записаны",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "webhook": {
      "main": [
        [
          {
            "node": "берем кандидатов в polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "согласившийся клиент": {
      "main": [
        [
          {
            "node": "Ответ админу о завершении опроса",
            "type": "main",
            "index": 0
          },
          {
            "node": "штамп согласился в polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "неуспевшие ответить": {
      "main": [
        [
          {
            "node": "Клиентам: опрос завершен",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Клиентам: опрос завершен": {
      "main": [
        [
          {
            "node": "штамп завершен в polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "результат опроса": {
      "main": [
        [
          {
            "node": "читаем polls4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "читаем polls1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "читаем polls3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "читаем polls1": {
      "main": [
        [
          {
            "node": "отказавшиеся",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "отказавшиеся": {
      "main": [
        [
          {
            "node": "штамп завершен в polls1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "штамп завершен в polls1": {
      "main": [
        [
          {
            "node": "Ответ админу об отказе1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "делаем ResumeUrl": {
      "main": [
        [
          {
            "node": "штамп ожидание в polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "читаем polls2": {
      "main": [
        [
          {
            "node": "неуспевшие ответить",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "читаем polls3": {
      "main": [
        [
          {
            "node": "ожидание",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ожидание": {
      "main": [
        [
          {
            "node": "штамп \"не ответил\" в polls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "штамп \"не ответил\" в polls": {
      "main": [
        [
          {
            "node": "Клиентам: опрос завершен1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Ответ админу о неуспешном опросе",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Приглашение клиентов",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Клиентам: опрос завершен1": {
      "main": [
        [
          {
            "node": "Админу: никто не ответил",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Проверка подписки": {
      "main": [
        [
          {
            "node": "Отбор клиентов по критериям",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Админу: никто не ответил": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "кто-то соответствует фильтрам?": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Админу: нет соответствующих клиентов",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "читаем polls4": {
      "main": [
        [
          {
            "node": "согласившийся клиент",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Админу: текущий статус опроса",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ответ админу об отказе1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "конфиг1": {
      "main": [
        [
          {
            "node": "Notify Admin Telegram1",
            "type": "main",
            "index": 0
          },
          {
            "node": "пишем логи в таблицу1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Trigger": {
      "main": [
        [
          {
            "node": "конфиг1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "03913acc-90d8-466e-94b4-ef68c28a47cc",
  "meta": {
    "instanceId": "5b9eb22fecd7346ef9ea053845d6437b25aa8c0a9fc5d298f42231642abb54cd"
  },
  "id": "2bFDhGmYvdq2l210",
  "tags": []
}